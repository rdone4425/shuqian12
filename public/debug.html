<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>数据库状态检查</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
      background: #f5f5f5;
    }
    .container {
      background: white;
      padding: 30px;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    .status-item {
      margin: 15px 0;
      padding: 15px;
      border-radius: 8px;
      border-left: 4px solid #ddd;
    }
    .status-success {
      background: #f0f9ff;
      border-left-color: #10b981;
      color: #065f46;
    }
    .status-error {
      background: #fef2f2;
      border-left-color: #ef4444;
      color: #991b1b;
    }
    .status-warning {
      background: #fffbeb;
      border-left-color: #f59e0b;
      color: #92400e;
    }
    .status-info {
      background: #f0f9ff;
      border-left-color: #3b82f6;
      color: #1e40af;
    }
    button {
      background: #3b82f6;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 6px;
      cursor: pointer;
      margin: 10px 5px;
    }
    button:hover {
      background: #2563eb;
    }
    button:disabled {
      background: #9ca3af;
      cursor: not-allowed;
    }
    pre {
      background: #f3f4f6;
      padding: 15px;
      border-radius: 6px;
      overflow-x: auto;
      font-size: 14px;
    }
    .loading {
      color: #6b7280;
      font-style: italic;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>🔍 数据库状态检查</h1>
    <p>这个页面帮助你诊断数据库连接和配置问题。</p>

    <div class="status-item status-info">
      <h3>📋 检查步骤</h3>
      <ol>
        <li>检查API基本连接</li>
        <li>检查数据库绑定状态</li>
        <li>检查数据库表结构</li>
        <li>测试基本数据操作</li>
      </ol>
    </div>

    <button onclick="runAllChecks()">🚀 开始检查</button>
    <button onclick="clearResults()">🧹 清除结果</button>

    <div id="results"></div>
  </div>

  <script>
    const results = document.getElementById('results');

    function addResult(title, content, type = 'info') {
      const div = document.createElement('div');
      div.className = `status-item status-${type}`;
      div.innerHTML = `<h3>${title}</h3><div>${content}</div>`;
      results.appendChild(div);
    }

    function clearResults() {
      results.innerHTML = '';
    }

    async function runAllChecks() {
      clearResults();

      // 检查1: API基本连接
      addResult('🔄 检查1: API基本连接', '<span class="loading">检查中...</span>');
      try {
        const response = await fetch('/api/status');
        const data = await response.json();

        if (response.ok) {
          addResult('✅ 检查1: API基本连接', `
            <p><strong>状态:</strong> ${response.status} ${response.statusText}</p>
            <p><strong>响应:</strong></p>
            <pre>${JSON.stringify(data, null, 2)}</pre>
          `, 'success');
        } else {
          addResult('❌ 检查1: API基本连接', `
            <p><strong>错误:</strong> ${response.status} ${response.statusText}</p>
            <pre>${JSON.stringify(data, null, 2)}</pre>
          `, 'error');
        }
      } catch (error) {
        addResult('❌ 检查1: API基本连接', `
          <p><strong>网络错误:</strong> ${error.message}</p>
          <p>可能原因：</p>
          <ul>
            <li>Functions未正确部署</li>
            <li>API路由配置错误</li>
            <li>网络连接问题</li>
          </ul>
        `, 'error');
      }

      // 检查2: 数据库绑定
      addResult('🔄 检查2: 数据库绑定状态', '<span class="loading">检查中...</span>');
      try {
        const response = await fetch('/api/bookmarks?limit=1');
        const data = await response.json();

        if (data.success) {
          addResult('✅ 检查2: 数据库绑定状态', `
            <p><strong>数据库已正确绑定</strong></p>
            <p>可以正常查询数据</p>
          `, 'success');
        } else if (data.message && data.message.includes('数据库未绑定')) {
          addResult('❌ 检查2: 数据库绑定状态', `
            <p><strong>数据库未绑定</strong></p>
            <p>请按照以下步骤绑定D1数据库：</p>
            <ol>
              <li>在Cloudflare Dashboard中创建D1数据库</li>
              <li>在Pages项目设置中绑定数据库（变量名：DB）</li>
              <li>重新部署项目</li>
            </ol>
          `, 'error');
        } else {
          addResult('⚠️ 检查2: 数据库绑定状态', `
            <p><strong>数据库已绑定，但可能需要初始化</strong></p>
            <p><strong>错误信息:</strong> ${data.message}</p>
          `, 'warning');
        }
      } catch (error) {
        addResult('❌ 检查2: 数据库绑定状态', `
          <p><strong>检查失败:</strong> ${error.message}</p>
        `, 'error');
      }

      // 检查3: 设置API
      addResult('🔄 检查3: 设置API状态', '<span class="loading">检查中...</span>');
      try {
        const response = await fetch('/api/settings');
        const data = await response.json();

        if (data.success) {
          addResult('✅ 检查3: 设置API状态', `
            <p><strong>设置API正常</strong></p>
            <pre>${JSON.stringify(data, null, 2)}</pre>
          `, 'success');
        } else {
          addResult('⚠️ 检查3: 设置API状态', `
            <p><strong>设置API有问题:</strong> ${data.message}</p>
            <pre>${JSON.stringify(data, null, 2)}</pre>
          `, 'warning');
        }
      } catch (error) {
        addResult('❌ 检查3: 设置API状态', `
          <p><strong>设置API失败:</strong> ${error.message}</p>
        `, 'error');
      }

      // 检查4: 统计API
      addResult('🔄 检查4: 统计API状态', '<span class="loading">检查中...</span>');
      try {
        const response = await fetch('/api/stats');
        const data = await response.json();

        if (data.success) {
          addResult('✅ 检查4: 统计API状态', `
            <p><strong>统计API正常</strong></p>
            <pre>${JSON.stringify(data, null, 2)}</pre>
          `, 'success');
        } else {
          addResult('⚠️ 检查4: 统计API状态', `
            <p><strong>统计API有问题:</strong> ${data.message}</p>
            <pre>${JSON.stringify(data, null, 2)}</pre>
          `, 'warning');
        }
      } catch (error) {
        addResult('❌ 检查4: 统计API状态', `
          <p><strong>统计API失败:</strong> ${error.message}</p>
        `, 'error');
      }

      // 检查5: 书签数据
      addResult('🔄 检查5: 书签数据', '<span class="loading">检查中...</span>');
      try {
        const response = await fetch('/api/bookmarks?limit=5');
        const data = await response.json();

        if (data.success) {
          addResult('✅ 检查5: 书签数据', `
            <p><strong>书签API正常</strong></p>
            <p><strong>书签数量:</strong> ${data.total || 0}</p>
            <p><strong>返回数据:</strong></p>
            <pre>${JSON.stringify(data, null, 2)}</pre>
          `, data.total > 0 ? 'success' : 'warning');
        } else {
          addResult('⚠️ 检查5: 书签数据', `
            <p><strong>书签API有问题:</strong> ${data.message}</p>
            <pre>${JSON.stringify(data, null, 2)}</pre>
          `, 'warning');
        }
      } catch (error) {
        addResult('❌ 检查5: 书签数据', `
          <p><strong>书签API失败:</strong> ${error.message}</p>
        `, 'error');
      }

      addResult('🎉 检查完成', `
        <p>所有检查已完成。请根据上述结果进行相应的修复操作。</p>
        <p><strong>常见解决方案：</strong></p>
        <ul>
          <li>如果数据库未绑定：在Cloudflare Pages设置中绑定D1数据库</li>
          <li>如果需要初始化：访问 <a href="/admin.html">管理后台</a> 进行初始化</li>
          <li>如果API错误：检查Functions部署状态</li>
          <li>如果书签数量为0：需要先添加一些书签数据</li>
        </ul>
      `, 'info');
    }
  </script>
</body>
</html>
