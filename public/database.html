<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>数据库管理 - 书签管理系统</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <link rel="stylesheet" href="css/database.css">

</head>
<body>
  <div class="admin-container">
    <!-- 导航栏 -->
    <nav class="admin-nav">
      <div class="nav-brand">
        <i class="fas fa-database"></i>
        <span>数据库管理</span>
      </div>
      <div class="nav-links">
        <a href="admin.html" class="nav-link">
          <i class="fas fa-arrow-left"></i>
          返回管理后台
        </a>
        <a href="index.html" class="nav-link">
          <i class="fas fa-home"></i>
          前台首页
        </a>
      </div>
    </nav>

    <!-- 主要内容 -->
    <main class="admin-main">
      <!-- 面包屑导航 -->
      <div class="breadcrumb">
        <a href="admin.html">管理后台</a> / 数据库管理
      </div>

      <!-- 页面标题 -->
      <div class="database-header">
        <h1><i class="fas fa-database"></i> 数据库管理中心</h1>
        <p>管理和维护书签系统的数据库结构</p>
      </div>

      <!-- 快速统计 -->
      <div class="quick-stats" id="quickStats">
        <div class="stat-card">
          <div class="stat-number" id="statTables">-</div>
          <div class="stat-label">数据表</div>
        </div>
        <div class="stat-card">
          <div class="stat-number" id="statIndexes">-</div>
          <div class="stat-label">索引</div>
        </div>
        <div class="stat-card">
          <div class="stat-number" id="statHealth">-</div>
          <div class="stat-label">健康度</div>
        </div>
        <div class="stat-card">
          <div class="stat-number" id="statBookmarks">-</div>
          <div class="stat-label">书签数量</div>
        </div>
      </div>

      <!-- 数据库管理功能卡片 -->
      <div class="database-grid">
        <!-- D1数据库状态 -->
        <div class="database-card">
          <h3><i class="fas fa-link"></i> D1数据库状态</h3>
          <div class="status-indicator status-unknown" id="d1Status">
            <i class="fas fa-spinner fa-spin"></i>
            检查中...
          </div>
          <p>检查Cloudflare D1数据库的绑定和连接状态</p>
          <div class="card-actions">
            <button class="btn btn-primary" onclick="checkDatabaseStructure()">
              <i class="fas fa-search"></i>
              检查状态
            </button>
          </div>
        </div>

        <!-- 数据库初始化 -->
        <div class="database-card">
          <h3><i class="fas fa-magic"></i> 数据库初始化</h3>
          <p>创建书签系统所需的所有数据表和索引结构</p>
          <div class="card-actions">
            <button class="btn btn-success" onclick="initializeDatabase()">
              <i class="fas fa-play"></i>
              初始化数据库
            </button>
          </div>
        </div>

        <!-- 插件表管理 -->
        <div class="database-card">
          <h3><i class="fas fa-puzzle-piece"></i> 插件表管理</h3>
          <p>管理Chrome插件相关的数据表结构</p>
          <div class="card-actions">
            <button class="btn btn-info" onclick="checkPluginTables()">
              <i class="fas fa-search"></i>
              检查插件表
            </button>
            <button class="btn btn-success" onclick="createPluginTables()">
              <i class="fas fa-plus"></i>
              创建插件表
            </button>
          </div>
        </div>

        <!-- 创建自定义表 -->
        <div class="database-card">
          <h3><i class="fas fa-table"></i> 自定义表创建</h3>
          <p>为插件或扩展功能创建自定义的数据库表</p>
          <div class="card-actions">
            <button class="btn btn-warning" onclick="showCreatePluginTableDialog()">
              <i class="fas fa-plus-circle"></i>
              创建新表
            </button>
          </div>
        </div>

        <!-- 数据备份 -->
        <div class="database-card">
          <h3><i class="fas fa-download"></i> 数据备份</h3>
          <p>导出数据库数据进行备份或迁移</p>
          <div class="card-actions">
            <button class="btn btn-secondary" onclick="exportDatabaseData()">
              <i class="fas fa-file-export"></i>
              导出数据
            </button>
          </div>
        </div>

        <!-- 数据清理 -->
        <div class="database-card">
          <h3><i class="fas fa-broom"></i> 数据清理</h3>
          <p>清理无效数据和优化数据库性能</p>
          <div class="card-actions">
            <button class="btn btn-warning" onclick="cleanupDatabase()">
              <i class="fas fa-trash-alt"></i>
              清理数据
            </button>
          </div>
        </div>
      </div>

      <!-- 数据库日志 -->
      <div class="database-card">
        <h3><i class="fas fa-history"></i> 数据库操作日志</h3>
        <p>查看最近的数据库操作记录</p>
        <div class="card-actions">
          <button class="btn btn-info" onclick="showDatabaseLogs()">
            <i class="fas fa-list"></i>
            查看日志
          </button>
          <button class="btn btn-secondary" onclick="clearDatabaseLogs()">
            <i class="fas fa-eraser"></i>
            清空日志
          </button>
        </div>
      </div>
    </main>
  </div>

  <!-- 引入管理后台的JavaScript -->
  <script src="js/admin.js"></script>
  <script>
    // 页面加载时自动检查数据库状态
    document.addEventListener('DOMContentLoaded', async function() {
      await updateDatabaseStats();
    });

    // 更新数据库统计信息
    async function updateDatabaseStats() {
      try {
        const response = await fetch('/api/check-database');
        const data = await response.json();

        if (data.success) {
          // 更新D1状态
          const d1StatusElement = document.getElementById('d1Status');
          const d1Binding = data.d1_binding;

          if (d1Binding.bound) {
            d1StatusElement.className = 'status-indicator status-healthy';
            d1StatusElement.innerHTML = '<i class="fas fa-check-circle"></i> D1数据库已连接';
          } else {
            d1StatusElement.className = 'status-indicator status-error';
            d1StatusElement.innerHTML = '<i class="fas fa-times-circle"></i> D1数据库未绑定';
          }

          // 更新统计数据
          const tables = data.tables;
          const indexes = data.indexes;
          const health = data.database_health;

          document.getElementById('statTables').textContent = tables.existing.length;
          document.getElementById('statIndexes').textContent = Object.keys(indexes.checks).length;
          document.getElementById('statHealth').textContent = health.percentage + '%';

          // 获取书签数量
          try {
            const bookmarksResponse = await fetch('/api/bookmarks?page=1&limit=1');
            const bookmarksData = await bookmarksResponse.json();
            if (bookmarksData.success) {
              document.getElementById('statBookmarks').textContent = bookmarksData.total || 0;
            }
          } catch (error) {
            document.getElementById('statBookmarks').textContent = '?';
          }
        } else {
          // 数据库检查失败
          const d1StatusElement = document.getElementById('d1Status');
          d1StatusElement.className = 'status-indicator status-error';
          d1StatusElement.innerHTML = '<i class="fas fa-exclamation-triangle"></i> 检查失败';
        }
      } catch (error) {
        console.error('更新数据库统计失败:', error);
        const d1StatusElement = document.getElementById('d1Status');
        d1StatusElement.className = 'status-indicator status-error';
        d1StatusElement.innerHTML = '<i class="fas fa-exclamation-triangle"></i> 连接错误';
      }
    }

    // 导出数据库数据
    async function exportDatabaseData() {
      showNotification('数据导出功能开发中...', 'info');
    }

    // 清理数据库
    async function cleanupDatabase() {
      if (!confirm('确定要清理数据库吗？\n\n这将删除无效的数据和优化数据库结构。')) {
        return;
      }
      showNotification('数据清理功能开发中...', 'info');
    }

    // 显示数据库日志
    async function showDatabaseLogs() {
      showNotification('数据库日志功能开发中...', 'info');
    }

    // 清空数据库日志
    async function clearDatabaseLogs() {
      if (!confirm('确定要清空数据库日志吗？')) {
        return;
      }
      showNotification('清空日志功能开发中...', 'info');
    }
  </script>
</body>
</html>
