<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>API测试页面</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
      background: #f5f5f5;
    }
    .test-card {
      background: white;
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .test-button {
      background: #007bff;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 4px;
      cursor: pointer;
      margin-right: 10px;
      margin-bottom: 10px;
    }
    .test-button:hover {
      background: #0056b3;
    }
    .result {
      background: #f8f9fa;
      border: 1px solid #dee2e6;
      border-radius: 4px;
      padding: 15px;
      margin-top: 10px;
      white-space: pre-wrap;
      font-family: monospace;
      font-size: 12px;
      max-height: 400px;
      overflow-y: auto;
    }
    .success { border-color: #28a745; background: #d4edda; }
    .error { border-color: #dc3545; background: #f8d7da; }
    .info { border-color: #17a2b8; background: #d1ecf1; }
  </style>
</head>
<body>
  <h1>🔧 API测试页面</h1>
  <p>这个页面用于测试和诊断API端点是否正常工作。</p>

  <div class="test-card">
    <h3>🧪 基础Functions测试</h3>
    <button class="test-button" onclick="testBasicFunction()">测试 /api/test (基础Functions)</button>
    <div id="test-result" class="result" style="display: none;"></div>
  </div>

  <div class="test-card">
    <h3>数据库检查API</h3>
    <button class="test-button" onclick="testCheckDatabase()">测试 /api/check-database</button>
    <div id="check-database-result" class="result" style="display: none;"></div>
  </div>

  <div class="test-card">
    <h3>数据库初始化API</h3>
    <button class="test-button" onclick="testInitDatabase()">测试 /api/init-database</button>
    <div id="init-database-result" class="result" style="display: none;"></div>
  </div>

  <div class="test-card">
    <h3>状态API</h3>
    <button class="test-button" onclick="testStatus()">测试 /api/status</button>
    <div id="status-result" class="result" style="display: none;"></div>
  </div>

  <div class="test-card">
    <h3>统计API</h3>
    <button class="test-button" onclick="testStats()">测试 /api/stats</button>
    <div id="stats-result" class="result" style="display: none;"></div>
  </div>

  <div class="test-card">
    <h3>书签API</h3>
    <button class="test-button" onclick="testBookmarks()">测试 /api/bookmarks</button>
    <div id="bookmarks-result" class="result" style="display: none;"></div>
  </div>

  <script>
    async function testAPI(endpoint, method = 'GET', body = null) {
      const resultId = endpoint.replace('/api/', '') + '-result';
      const resultElement = document.getElementById(resultId);

      resultElement.style.display = 'block';
      resultElement.className = 'result info';
      resultElement.textContent = `正在测试 ${endpoint}...`;

      try {
        const options = { method };
        if (body) {
          options.headers = { 'Content-Type': 'application/json' };
          options.body = JSON.stringify(body);
        }

        const response = await fetch(endpoint, options);

        const responseInfo = {
          status: response.status,
          statusText: response.statusText,
          headers: Object.fromEntries(response.headers.entries()),
          url: response.url
        };

        let responseData;
        const contentType = response.headers.get('content-type');

        if (contentType && contentType.includes('application/json')) {
          try {
            responseData = await response.json();
          } catch (jsonError) {
            responseData = `JSON解析失败: ${jsonError.message}`;
          }
        } else {
          const text = await response.text();
          responseData = `非JSON响应 (${contentType}):\n${text.substring(0, 500)}${text.length > 500 ? '...' : ''}`;
        }

        const result = {
          endpoint,
          method,
          response: responseInfo,
          data: responseData
        };

        resultElement.className = response.ok ? 'result success' : 'result error';
        resultElement.textContent = JSON.stringify(result, null, 2);

      } catch (error) {
        resultElement.className = 'result error';
        resultElement.textContent = `请求失败:\n${error.message}\n\n错误详情:\n${error.stack}`;
      }
    }

    function testBasicFunction() {
      testAPI('/api/test');
    }

    function testCheckDatabase() {
      testAPI('/api/check-database');
    }

    function testInitDatabase() {
      testAPI('/api/init-database', 'POST');
    }

    function testStatus() {
      testAPI('/api/status');
    }

    function testStats() {
      testAPI('/api/stats');
    }

    function testBookmarks() {
      testAPI('/api/bookmarks');
    }

    function testBasicFunction() {
      testAPI('/api/test');
    }

    // 页面加载时自动测试基础功能
    window.addEventListener('load', () => {
      setTimeout(() => {
        testBasicFunction();
      }, 500);

      setTimeout(() => {
        testCheckDatabase();
      }, 1500);
    });
  </script>
</body>
</html>
