<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>中间件测试页面</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .info {
            background: #e3f2fd;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
        }
        .success {
            background: #e8f5e8;
            color: #2e7d32;
        }
        .error {
            background: #ffebee;
            color: #c62828;
        }
        button {
            background: #1976d2;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #1565c0;
        }
        #results {
            margin-top: 20px;
            padding: 15px;
            background: #f9f9f9;
            border-radius: 5px;
            white-space: pre-wrap;
            font-family: monospace;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🔧 中间件测试页面</h1>
        
        <div class="info">
            <h3>测试说明</h3>
            <p>这个页面用于测试路径保护中间件是否正常工作。</p>
            <p><strong>当前路径:</strong> <span id="currentPath"></span></p>
            <p><strong>当前时间:</strong> <span id="currentTime"></span></p>
        </div>

        <div class="info success">
            <h3>✅ 中间件工作正常</h3>
            <p>如果你能看到这个页面，说明中间件没有阻止这个路径的访问。</p>
        </div>

        <h3>测试功能</h3>
        <button onclick="testDatabaseStatus()">检查数据库状态</button>
        <button onclick="testPathSettings()">检查路径设置</button>
        <button onclick="testSpecificPath()">测试特定路径</button>
        <button onclick="clearResults()">清空结果</button>

        <div id="results"></div>
    </div>

    <script>
        // 显示当前路径和时间
        document.getElementById('currentPath').textContent = window.location.pathname;
        document.getElementById('currentTime').textContent = new Date().toLocaleString();

        const resultsDiv = document.getElementById('results');

        function log(message) {
            resultsDiv.textContent += new Date().toLocaleTimeString() + ': ' + message + '\n';
        }

        function clearResults() {
            resultsDiv.textContent = '';
        }

        async function testDatabaseStatus() {
            log('正在检查数据库状态...');
            try {
                const response = await fetch('/api/database/status');
                const data = await response.json();
                
                if (data.success) {
                    log('✅ 数据库状态检查成功');
                    log(`- 数据库已配置: ${data.status.dbConfigured}`);
                    log(`- 表结构完整: ${data.status.tablesExist}`);
                    log(`- 已初始化: ${data.isInitialized}`);
                    log(`- 设置数量: ${data.status.settingsCount}`);
                    
                    if (data.status.settings.home_path) {
                        log(`- 首页路径: ${data.status.settings.home_path}`);
                    }
                    if (data.status.settings.admin_path) {
                        log(`- 管理路径: ${data.status.settings.admin_path}`);
                    }
                    log(`- 首页保护: ${data.status.settings.enable_home_path}`);
                } else {
                    log('❌ 数据库状态检查失败: ' + data.message);
                }
            } catch (error) {
                log('❌ 请求失败: ' + error.message);
            }
        }

        async function testPathSettings() {
            log('正在检查路径保护设置...');
            try {
                const response = await fetch('/api/debug/path-protection');
                const data = await response.json();
                
                if (data.success) {
                    log('✅ 路径保护设置检查成功');
                    const analysis = data.analysis;
                    log(`- 数据库已初始化: ${analysis.dbInitialized}`);
                    log(`- 首页路径保护: ${analysis.pathProtection.homePathEnabled}`);
                    log(`- 首页路径: ${analysis.pathProtection.homePathValue || '未设置'}`);
                    log(`- 管理路径: ${analysis.pathProtection.adminPathValue || '未设置'}`);
                    
                    if (data.suggestions.length > 0) {
                        log('建议:');
                        data.suggestions.forEach(suggestion => {
                            log(`  - ${suggestion}`);
                        });
                    }
                } else {
                    log('❌ 路径保护设置检查失败: ' + data.message);
                }
            } catch (error) {
                log('❌ 请求失败: ' + error.message);
            }
        }

        async function testSpecificPath() {
            const testPath = prompt('请输入要测试的路径:', '/y1veh6');
            if (!testPath) return;
            
            log(`正在测试路径: ${testPath}`);
            try {
                const response = await fetch(`/api/debug/middleware-test?path=${encodeURIComponent(testPath)}`);
                const data = await response.json();
                
                if (data.success) {
                    log('✅ 路径测试成功');
                    const analysis = data.analysis;
                    log(`- 测试路径: ${analysis.testPath}`);
                    log(`- 匹配受保护首页: ${analysis.matches.protectedHomePath.matches}`);
                    log(`- 匹配受保护管理页: ${analysis.matches.protectedAdminPath.matches}`);
                    log(`- 会被阻止: ${analysis.matches.blockedPaths.wouldBlock}`);
                    log(`- 建议: ${data.suggestions[0] || '无'}`);
                    
                    if (analysis.matches.protectedHomePath.expectedPaths.length > 0) {
                        log('期望的首页路径:');
                        analysis.matches.protectedHomePath.expectedPaths.forEach(path => {
                            log(`  - ${path}`);
                        });
                    }
                } else {
                    log('❌ 路径测试失败: ' + data.message);
                }
            } catch (error) {
                log('❌ 请求失败: ' + error.message);
            }
        }

        // 页面加载时自动检查
        window.addEventListener('load', () => {
            log('页面加载完成，开始自动检查...');
            testDatabaseStatus();
        });
    </script>
</body>
</html>
