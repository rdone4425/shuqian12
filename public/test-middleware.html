<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¸­é—´ä»¶æµ‹è¯•é¡µé¢</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .info {
            background: #e3f2fd;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
        }
        .success {
            background: #e8f5e8;
            color: #2e7d32;
        }
        .error {
            background: #ffebee;
            color: #c62828;
        }
        button {
            background: #1976d2;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #1565c0;
        }
        #results {
            margin-top: 20px;
            padding: 15px;
            background: #f9f9f9;
            border-radius: 5px;
            white-space: pre-wrap;
            font-family: monospace;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”§ ä¸­é—´ä»¶æµ‹è¯•é¡µé¢</h1>
        
        <div class="info">
            <h3>æµ‹è¯•è¯´æ˜</h3>
            <p>è¿™ä¸ªé¡µé¢ç”¨äºæµ‹è¯•è·¯å¾„ä¿æŠ¤ä¸­é—´ä»¶æ˜¯å¦æ­£å¸¸å·¥ä½œã€‚</p>
            <p><strong>å½“å‰è·¯å¾„:</strong> <span id="currentPath"></span></p>
            <p><strong>å½“å‰æ—¶é—´:</strong> <span id="currentTime"></span></p>
        </div>

        <div class="info success">
            <h3>âœ… ä¸­é—´ä»¶å·¥ä½œæ­£å¸¸</h3>
            <p>å¦‚æœä½ èƒ½çœ‹åˆ°è¿™ä¸ªé¡µé¢ï¼Œè¯´æ˜ä¸­é—´ä»¶æ²¡æœ‰é˜»æ­¢è¿™ä¸ªè·¯å¾„çš„è®¿é—®ã€‚</p>
        </div>

        <h3>æµ‹è¯•åŠŸèƒ½</h3>
        <button onclick="testDatabaseStatus()">æ£€æŸ¥æ•°æ®åº“çŠ¶æ€</button>
        <button onclick="testPathSettings()">æ£€æŸ¥è·¯å¾„è®¾ç½®</button>
        <button onclick="testSpecificPath()">æµ‹è¯•ç‰¹å®šè·¯å¾„</button>
        <button onclick="clearResults()">æ¸…ç©ºç»“æœ</button>

        <div id="results"></div>
    </div>

    <script>
        // æ˜¾ç¤ºå½“å‰è·¯å¾„å’Œæ—¶é—´
        document.getElementById('currentPath').textContent = window.location.pathname;
        document.getElementById('currentTime').textContent = new Date().toLocaleString();

        const resultsDiv = document.getElementById('results');

        function log(message) {
            resultsDiv.textContent += new Date().toLocaleTimeString() + ': ' + message + '\n';
        }

        function clearResults() {
            resultsDiv.textContent = '';
        }

        async function testDatabaseStatus() {
            log('æ­£åœ¨æ£€æŸ¥æ•°æ®åº“çŠ¶æ€...');
            try {
                const response = await fetch('/api/database/status');
                const data = await response.json();
                
                if (data.success) {
                    log('âœ… æ•°æ®åº“çŠ¶æ€æ£€æŸ¥æˆåŠŸ');
                    log(`- æ•°æ®åº“å·²é…ç½®: ${data.status.dbConfigured}`);
                    log(`- è¡¨ç»“æ„å®Œæ•´: ${data.status.tablesExist}`);
                    log(`- å·²åˆå§‹åŒ–: ${data.isInitialized}`);
                    log(`- è®¾ç½®æ•°é‡: ${data.status.settingsCount}`);
                    
                    if (data.status.settings.home_path) {
                        log(`- é¦–é¡µè·¯å¾„: ${data.status.settings.home_path}`);
                    }
                    if (data.status.settings.admin_path) {
                        log(`- ç®¡ç†è·¯å¾„: ${data.status.settings.admin_path}`);
                    }
                    log(`- é¦–é¡µä¿æŠ¤: ${data.status.settings.enable_home_path}`);
                } else {
                    log('âŒ æ•°æ®åº“çŠ¶æ€æ£€æŸ¥å¤±è´¥: ' + data.message);
                }
            } catch (error) {
                log('âŒ è¯·æ±‚å¤±è´¥: ' + error.message);
            }
        }

        async function testPathSettings() {
            log('æ­£åœ¨æ£€æŸ¥è·¯å¾„ä¿æŠ¤è®¾ç½®...');
            try {
                const response = await fetch('/api/debug/path-protection');
                const data = await response.json();
                
                if (data.success) {
                    log('âœ… è·¯å¾„ä¿æŠ¤è®¾ç½®æ£€æŸ¥æˆåŠŸ');
                    const analysis = data.analysis;
                    log(`- æ•°æ®åº“å·²åˆå§‹åŒ–: ${analysis.dbInitialized}`);
                    log(`- é¦–é¡µè·¯å¾„ä¿æŠ¤: ${analysis.pathProtection.homePathEnabled}`);
                    log(`- é¦–é¡µè·¯å¾„: ${analysis.pathProtection.homePathValue || 'æœªè®¾ç½®'}`);
                    log(`- ç®¡ç†è·¯å¾„: ${analysis.pathProtection.adminPathValue || 'æœªè®¾ç½®'}`);
                    
                    if (data.suggestions.length > 0) {
                        log('å»ºè®®:');
                        data.suggestions.forEach(suggestion => {
                            log(`  - ${suggestion}`);
                        });
                    }
                } else {
                    log('âŒ è·¯å¾„ä¿æŠ¤è®¾ç½®æ£€æŸ¥å¤±è´¥: ' + data.message);
                }
            } catch (error) {
                log('âŒ è¯·æ±‚å¤±è´¥: ' + error.message);
            }
        }

        async function testSpecificPath() {
            const testPath = prompt('è¯·è¾“å…¥è¦æµ‹è¯•çš„è·¯å¾„:', '/y1veh6');
            if (!testPath) return;
            
            log(`æ­£åœ¨æµ‹è¯•è·¯å¾„: ${testPath}`);
            try {
                const response = await fetch(`/api/debug/middleware-test?path=${encodeURIComponent(testPath)}`);
                const data = await response.json();
                
                if (data.success) {
                    log('âœ… è·¯å¾„æµ‹è¯•æˆåŠŸ');
                    const analysis = data.analysis;
                    log(`- æµ‹è¯•è·¯å¾„: ${analysis.testPath}`);
                    log(`- åŒ¹é…å—ä¿æŠ¤é¦–é¡µ: ${analysis.matches.protectedHomePath.matches}`);
                    log(`- åŒ¹é…å—ä¿æŠ¤ç®¡ç†é¡µ: ${analysis.matches.protectedAdminPath.matches}`);
                    log(`- ä¼šè¢«é˜»æ­¢: ${analysis.matches.blockedPaths.wouldBlock}`);
                    log(`- å»ºè®®: ${data.suggestions[0] || 'æ— '}`);
                    
                    if (analysis.matches.protectedHomePath.expectedPaths.length > 0) {
                        log('æœŸæœ›çš„é¦–é¡µè·¯å¾„:');
                        analysis.matches.protectedHomePath.expectedPaths.forEach(path => {
                            log(`  - ${path}`);
                        });
                    }
                } else {
                    log('âŒ è·¯å¾„æµ‹è¯•å¤±è´¥: ' + data.message);
                }
            } catch (error) {
                log('âŒ è¯·æ±‚å¤±è´¥: ' + error.message);
            }
        }

        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æ£€æŸ¥
        window.addEventListener('load', () => {
            log('é¡µé¢åŠ è½½å®Œæˆï¼Œå¼€å§‹è‡ªåŠ¨æ£€æŸ¥...');
            testDatabaseStatus();
        });
    </script>
</body>
</html>
