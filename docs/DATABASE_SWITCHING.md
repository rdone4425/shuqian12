# 数据库切换功能使用指南

## 📋 功能概述

书签管理系统现在支持在 **Cloudflare D1** 和 **Turso** 数据库之间切换，让你可以根据性能需求选择最适合的数据库。

## 🚀 快速开始

### 1. 配置 Turso 数据库

⚠️ **重要提示**: 由于构建环境限制，Turso 功能需要在部署后手动启用。

详细设置步骤请参考：[Turso 设置指南](TURSO_SETUP.md)

#### 简要步骤：
1. 部署项目到 Cloudflare Pages
2. 创建 Turso 数据库并获取连接信息
3. 在 Pages 设置中添加环境变量
4. 启用代码中的 Turso 功能
5. 重新部署

### 2. 使用数据库切换功能

#### 在管理后台中切换
1. 登录管理后台
2. 进入 **设置** 标签页
3. 在 **数据库设置** 部分：
   - 查看当前数据库类型
   - 选择要切换的数据库
   - 点击 **切换数据库** 按钮

#### 数据迁移
1. 在设置页面点击 **数据迁移** 按钮
2. 选择源数据库和目标数据库
3. 选择要迁移的表
4. 确认迁移操作

## 📊 性能对比

| 特性 | Cloudflare D1 | Turso |
|------|---------------|-------|
| **延迟** | 100-500ms | 5-20ms |
| **全球分布** | ✅ | ✅ |
| **成本** | 免费额度大 | 付费但性能好 |
| **兼容性** | SQLite | SQLite |
| **维护** | 无需维护 | 无需维护 |

## 🔧 API 接口

### 获取数据库状态
```http
GET /api/database/switch
```

### 切换数据库
```http
POST /api/database/switch
Content-Type: application/json

{
  "database_type": "turso"
}
```

### 数据迁移
```http
POST /api/database/migrate
Content-Type: application/json

{
  "from_type": "d1",
  "to_type": "turso",
  "tables": ["bookmarks", "categories", "settings"]
}
```

### 初始化 Turso 数据库
```http
POST /api/database/init-turso
```

## ⚠️ 注意事项

### 切换前的准备
1. **备份数据**: 切换前建议导出当前数据
2. **测试连接**: 确保目标数据库连接正常
3. **迁移数据**: 使用迁移功能同步数据

### 常见问题

#### Q: 切换后数据丢失了怎么办？
A: 数据库切换只是改变连接，不会删除原数据。可以切换回原数据库或重新迁移数据。

#### Q: 可以同时使用两个数据库吗？
A: 系统同时只能使用一个数据库，但可以在它们之间切换。

#### Q: Turso 配置错误怎么办？
A: 检查环境变量配置，确保 `TURSO_URL` 和 `TURSO_AUTH_TOKEN` 正确。

## 🎯 推荐使用场景

### 使用 D1 的情况
- ✅ 个人项目或小型应用
- ✅ 希望完全免费使用
- ✅ 对延迟要求不高
- ✅ 喜欢 Cloudflare 生态

### 使用 Turso 的情况
- ✅ 需要更低延迟
- ✅ 高频率查询应用
- ✅ 对性能要求较高
- ✅ 可以接受付费服务

## 🔄 迁移最佳实践

### 1. 渐进式迁移
```
1. 配置 Turso 数据库
2. 初始化 Turso 表结构
3. 迁移数据到 Turso
4. 测试 Turso 功能
5. 切换到 Turso
```

### 2. 回滚计划
```
1. 保留 D1 数据库
2. 记录切换时间
3. 监控性能变化
4. 必要时切换回 D1
```

## 📈 监控和维护

### 性能监控
- 在管理后台监控面板查看数据库性能
- 关注查询延迟和错误率
- 定期检查数据库连接状态

### 定期维护
- 定期备份重要数据
- 监控数据库使用量
- 更新环境变量配置

## 🆘 故障排除

### 连接问题
1. 检查环境变量配置
2. 验证网络连接
3. 查看错误日志

### 性能问题
1. 检查数据库负载
2. 优化查询语句
3. 考虑切换数据库类型

### 数据同步问题
1. 使用数据迁移功能
2. 检查表结构一致性
3. 验证数据完整性

---

## 📞 技术支持

如果遇到问题，请：
1. 查看管理后台的错误日志
2. 检查浏览器控制台错误
3. 参考本文档的故障排除部分
